# REST API – Simplified Endpoint List & CQRS (No Trip Requests/Generations/Telemetry)

[**Download this file**](sandbox:/mnt/data/.ai/api-plan-slim.md)

> **Base URL**: `/api/v1`  
> **Auth**: JWT (Bearer)  
> **Scope**: Only **Notes** and **Plans** (with plan lifecycle states surfaced directly), plus Auth/Profile.  
> **Note**: Internals may still use hidden tables/jobs, but they are _not exposed_ by this API.

---

## 1) Resources (Public Surface)

| Resource     | Purpose                                                                      |
| ------------ | ---------------------------------------------------------------------------- | ------- | --------- | ------------------------------------------- | -------- | ---------------------- |
| Users & Auth | Sign up/in                                                                   |
| Profiles     | Preferences                                                                  |
| Notes        | User notes CRUD (soft delete)                                                |
| Plans        | Create + list + manage lifecycle; surface both **generationStatus** (`queued | running | succeeded | failed`) and **decisionStatus** (`generated | accepted | rejected`) on the plan |
| Enums/Meta   | Enumerations and health                                                      |

---

## 2) Endpoints

### 2.1 Users & Auth

- **POST** `/users/signup` — Create account.
- **POST** `/users/signin` — Sign in, returns JWT.

### 2.2 Profiles

- **GET** `/profiles/me` — Get my profile.
- **PUT** `/profiles/me` — Upsert my profile (optional preferences).

### 2.3 Notes

- **GET** `/notes` — List my notes.
  - Query: `q`, `includeDeleted=false`, `sort=updated_at|created_at`, `order=desc|asc`, `limit`, `cursor`
- **POST** `/notes` — Create note (`title` 1–200, `location` 1–255, `bodyMd` 1000–10000).
- **GET** `/notes/{noteId}` — Get a note (404 if soft-deleted unless `includeDeleted=true`).
- **PUT** `/notes/{noteId}` — Update a note (full replace).
- **DELETE** `/notes/{noteId}` — Soft delete.
- **POST** `/notes/{noteId}:restore` — Restore soft-deleted note.

### 2.4 Plans (single surface, no trip-requests/generations exposed)

- **GET** `/plans` — List my plans.
  - Query filters:
    - `decisionStatus`: `generated|accepted|rejected`
    - `generationStatus`: `queued|running|succeeded|failed`
    - `acceptedOnly`: `true|false`
    - `noteId`: filter by source note
    - `structureType`: `daily|list`
    - `sort`: `created_at|updated_at` (default `created_at`), `order`: `desc|asc`
    - `limit`, `cursor`
- **POST** `/plans` — **Create/queue** a plan from a note. Returns a plan in `generationStatus=queued` (and `decisionStatus=generated`).
  - Body:
    ```json
    {
      "noteId": "uuid",
      "params": { "days": 7, "travelers": 2 }, // both optional; days>0? travelers>0?
      "model": { "temperature": 0.7, "maxTokens": 4000 } // optional; ignored in MVP if not needed
    }
    ```
- **GET** `/plans/{planId}` — Get a plan (poll this for loading UI).
- **PUT** `/plans/{planId}` — Update plan content (user edits). Sets `adjustedByUser=true`.
  - Body:
    ```json
    {
      "content": {
        /* canonical plan JSON */
      },
      "contentMd": "string|null"
    }
    ```
- **POST** `/plans/{planId}:accept` — Accept plan (enforces exactly one accepted per user note scope overall or per internal rules).
  - Body (optional): `{ "reason": "Looks good" }`
- **POST** `/plans/{planId}:reject` — Reject plan (optional reason).
  - Body (optional): `{ "reason": "Too generic" }`
- **POST** `/plans/{planId}:retry` — Re-queue generation for this plan (creates a new revision internally; externally stays same `planId`).
- **POST** `/plans/{planId}:cancel` — Attempt to cancel active generation (`generationStatus=running`). _(Best-effort)_
- **DELETE** `/plans/{planId}` — (Optional) Delete plan.

> **Canonical Plan JSON (example)**
>
> - If `params.days` provided → `structureType="daily"` + `daysCount=days`.
> - Otherwise `structureType="list"` (no `daysCount`).

**Plan object (response shape):**

```json
{
  "id": "uuid",
  "noteId": "uuid",
  "params": { "days": 7, "travelers": 2 },
  "structureType": "daily",
  "daysCount": 7,
  "content": {
    /* canonical plan JSON */
  },
  "contentMd": "string|null",
  "generationStatus": "queued", // queued|running|succeeded|failed
  "decisionStatus": "generated", // generated|accepted|rejected
  "errorMessage": null,
  "adjustedByUser": false,
  "decisionReason": null,
  "decisionAt": null,
  "createdAt": "ts",
  "updatedAt": "ts"
}
```

### 2.5 Enums & Metadata

- **GET** `/meta/enums` — Enumerations used by UI:
  ```json
  {
    "planDecisionStatus": ["generated", "accepted", "rejected"],
    "planGenerationStatus": ["queued", "running", "succeeded", "failed"],
    "planStructure": ["daily", "list"]
  }
  ```
- **GET** `/health` — Health check.

---

## 3) Global Conventions

- **Auth**: JWT required for all endpoints except `/users/signup`, `/users/signin`, `/health`.
- **Pagination**: `limit` (default 20, max 100) + `cursor` (opaque).
- **Sorting**: default `created_at DESC` (or `updated_at` for notes).
- **Idempotency**: Optional `Idempotency-Key` for POSTs (client can reuse on retries).
- **Errors**: JSON envelope `{ code, message, details?, correlationId }`.
- **Tenant Safety**: All operations implicitly scoped to authenticated user; server uses `sub` claim as `user_id`.

---

## 4) Example CQRS Names (No Implementation)

### Users & Auth

- **Commands**: `SignUp`, `SignIn`

### Profiles

- **Commands**: `UpsertMyProfile`
- **Queries**: `GetMyProfile`

### Notes

- **Commands**: `CreateNote`, `UpdateNote`, `DeleteNote`, `RestoreNote`
- **Queries**: `ListNotes`, `GetNote`

### Plans (flattened surface)

- **Commands**:
  - `CreatePlan` _(queues generation)_
  - `UpdatePlanContent`
  - `AcceptPlan`
  - `RejectPlan`
  - `RetryPlanGeneration`
  - `CancelPlanGeneration`
  - `DeletePlan` _(optional)_
- **Queries**:
  - `ListPlans`
  - `GetPlan`

**Endpoint → CQRS Quick Map**
| Endpoint | Command/Query |
|---|---|
| POST `/users/signup` | `SignUp` |
| POST `/users/signin` | `SignIn` |
| GET `/profiles/me` | `GetMyProfile` |
| PUT `/profiles/me` | `UpsertMyProfile` |
| GET `/notes` | `ListNotes` |
| POST `/notes` | `CreateNote` |
| GET `/notes/{id}` | `GetNote` |
| PUT `/notes/{id}` | `UpdateNote` |
| DELETE `/notes/{id}` | `DeleteNote` |
| POST `/notes/{id}:restore` | `RestoreNote` |
| GET `/plans` | `ListPlans` |
| POST `/plans` | `CreatePlan` |
| GET `/plans/{id}` | `GetPlan` |
| PUT `/plans/{id}` | `UpdatePlanContent` |
| POST `/plans/{id}:accept` | `AcceptPlan` |
| POST `/plans/{id}:reject` | `RejectPlan` |
| POST `/plans/{id}:retry` | `RetryPlanGeneration` |
| POST `/plans/{id}:cancel` | `CancelPlanGeneration` |
| DELETE `/plans/{id}` | `DeletePlan` |
| GET `/meta/enums` | _(read-only)_ |
| GET `/health` | _(health)_ |

---

## 5) Validation (High-Level)

- **Notes**: `title` 1–200; `location` 1–255; `bodyMd` 1000–10000.
- **Plans**:
  - `noteId` must belong to caller.
  - `params.days` > 0 if provided; `params.travelers` > 0 if provided.
  - `structureType`: `daily` requires `daysCount>0`; `list` requires `daysCount=null`.
  - Unique acceptance rule: only one `accepted` plan per _semantic scope_. _(Recommend per-note; choose per product decision.)_
  - `generationStatus` transitions: `queued → running → (succeeded|failed)` (server-managed).
  - On user edits, set `adjustedByUser=true`.

---

## 6) Frontend Notes (Angular)

- Poll `GET /plans/{id}` while `generationStatus` ∈ {`queued`,`running`} to show loading state.
- For listing, combine filters `generationStatus`/`decisionStatus` to build tabs: _In progress_, _Ready_, _Accepted_, _Rejected_.
- Use `cursor` for infinite scroll.
